<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.2.1/css/ol.css" type="text/css">
    <style>
      .map {
        height: 400px;
        width: 100%;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.2.1/build/ol.js"></script>
    <title>FindMyTranport</title>
  </head>
  <body>
    <h2>See the Location of the Tranport Vehicle</h2>
    <p>The red dot is the near real-time location of the vehicle and is updated every 10 seconds to keep the server running. Sorry for any inconvience. This product is <b>not final</b> and is still <b>under development</b>. We will continue to work to get things much more effeciently and scale up to meet user demands.</p>
    <div id="map" class="map"></div>
    <div id="locationDataBox"></div>
    <script type="text/javascript">
      // generate points features

      const vectorSource = new ol.source.Vector();
      let previousFeature = null;
      let isFetching = false;

      function fetchLocationData(callback) {
        if (isFetching) return;
        isFetching = true;
        fetch('https://tracktransport.azurewebsites.net/locations/65ded1920a2a2e2fd47bad30')
        .then(response => response.json())
        .then(data => {
          let locationData = [data.location.latitude, data.location.longitude];
          console.log(locationData);
          if (locationData) {
            if (previousFeature) {
              vectorSource.removeFeature(previousFeature);
            }
            const feature = new ol.Feature({
              geometry: new ol.geom.Point(locationData)
            });
            vectorSource.addFeature(feature);
            previousFeature = feature;
            document.getElementById('locationDataBox').innerText = `Latitude: ${locationData[0]}, Longitude: ${locationData[1]}`;
          }
          isFetching = false;
        })
        .catch(error => {
          console.error('Error:', error);
          isFetching = false;
        });
    }

      fetchLocationData();
      setInterval(fetchLocationData, 10000);

      // create the source and layer for random features
      const vectorLayer = new ol.layer.Vector({
        source: vectorSource,
        style: new ol.style.Style({
          image: new ol.style.Circle({
            radius: 2,
            fill: new ol.style.Fill({color: 'red'})
          })
        })
      });
      // create map and add layers
      const map = new ol.Map({
        target: 'map',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.OSM()
          }),
          vectorLayer
        ],
        view: new ol.View({
          center: ol.proj.fromLonLat([121.078999, 14.640817]),
          zoom: 18
        })
      });
    </script>
  </body>
</html>
